name: 'Clean Github Actions Runner'
description: 'Remove unneeded packages and clean up disk space on the Github Actions runner'

runs:
  using: 'composite'
  steps:
    - name: Get current disk usage
      shell: bash
      run: |
        start_time=$SECONDS

        echo "Getting disk free space"
        df -h

        echo "Getting /usr/share disk usage"
        du -shc /usr/share/* | sort -hr | head -n 10

        echo "Getting /usr/local/share disk usage"
        du -shc /usr/local/share/* | sort -hr | head -n 10

        echo "Getting /usr/local/lib disk usage"
        du -shc /usr/local/lib/* | sort -hr | head -n 10

        echo "Getting tool cache disk usage"
        du -shc "$AGENT_TOOLSDIRECTORY"/* | sort -hr | head -n 10

        echo "Disk usage check took $(($SECONDS - $start_time)) seconds"

    - name: Clean unneeded packages
      shell: bash
      run: |
        start_time=$SECONDS

        echo "Removing unneeded packages"
        sudo rm -rf /usr/share/dotnet/
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm "$AGENT_TOOLSDIRECTORY"/Python
        sudo rm "$AGENT_TOOLSDIRECTORY"/CodeQL
        sudo rm "$AGENT_TOOLSDIRECTORY"/go
        sudo rm "$AGENT_TOOLSDIRECTORY"/PyPy

        echo "Package removal took $(($SECONDS - $start_time)) seconds"

    - name: Print final disk usage
      shell: bash
      run: |
        start_time=$SECONDS

        echo "Getting final disk free space"
        df -h

        echo "Final disk usage check took $(($SECONDS - $start_time)) seconds"